<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Calculadora de Energia — SCEE</title>
  <style>
    :root{
      --bg1: #0f1220;
      --bg2: #121629;
      --card: rgba(255,255,255,0.08);
      --stroke: rgba(255,255,255,0.14);
      --accent: #5dd3ff;
      --accent-2: #86f7c2;
      --text: #f4f6fb;
      --muted: #c8cbe0;
      --danger: #ff6b6b;
      --ok: #86f7c2;
      --radius: 14px;
      --radius-sm: 10px;
      --shadow: 0 8px 30px rgba(0,0,0,.35);
      --glass: blur(10px) saturate(140%);
    }
    *{box-sizing: border-box}
    html,body{height:100%}
    body{
      margin:0;
      color:var(--text);
      background: radial-gradient(1200px 900px at 20% -10%, #1b2550 0%, transparent 60%),
                  radial-gradient(1000px 700px at 110% 30%, #153a2f 0%, transparent 55%),
                  linear-gradient(180deg, var(--bg1), var(--bg2));
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      letter-spacing:.2px;
    }
    .wrap{
      min-height:100%;
      display:grid;
      place-items:center;
      padding:32px 20px;
    }
    .shell{
      width:100%;
      max-width:980px;
      display:grid;
      gap:20px;
      grid-template-columns: 1.1fr .9fr;
    }
    @media (max-width: 900px){
      .shell{grid-template-columns: 1fr}
    }
    .card{
      backdrop-filter: var(--glass);
      -webkit-backdrop-filter: var(--glass);
      background: var(--card);
      border:1px solid var(--stroke);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding:22px;
      position:relative;
      overflow:hidden;
    }
    .card::after{
      content:"";
      position:absolute;
      inset: -60% -40% auto auto;
      height:240px; width:240px;
      background: conic-gradient(from 0deg, var(--accent), transparent 25%, var(--accent-2), transparent 50%, var(--accent), transparent 75%, var(--accent-2));
      opacity:.18;
      filter: blur(30px);
      border-radius:50%;
      transform: translate3d(0,0,0) rotate(0deg);
      animation: swirl 12s linear infinite;
      pointer-events:none;
    }
    @keyframes swirl { to{ transform: rotate(360deg)} }

    h1{
      font-size: clamp(20px, 2.2vw, 28px);
      margin:0 0 16px;
      font-weight:700;
      letter-spacing:.3px;
    }
    p.sub{
      margin: -6px 0 18px;
      color: var(--muted);
      font-size: 14px;
    }

    .grid{ display:grid; gap:14px }
    label.lbl{ display:block; font-size:13px; color:var(--muted); margin-bottom:8px }
    .field{ position:relative }
    .inp{
      width:100%;
      background: rgba(255,255,255,0.06);
      border: 1px solid var(--stroke);
      border-radius: var(--radius-sm);
      color:var(--text);
      padding:14px 44px 14px 14px;
      font-size:16px;
      outline:none;
      transition: border-color .2s, box-shadow .2s, transform .06s;
    }
    .inp:focus{ border-color: rgba(93,211,255,.7); box-shadow: 0 0 0 6px rgba(93,211,255,.12) }
    .suffix{
      position:absolute; right:10px; top:50%; translate: 0 -50%;
      color:var(--muted); font-size:13px; padding:4px 8px;
      border:1px dashed var(--stroke); border-radius: 8px; pointer-events:none;
    }

    .row{display:flex; gap:12px; align-items:center; flex-wrap:wrap}
    .chip{
      --chip-bg: rgba(255,255,255,0.06);
      display:inline-flex; align-items:center; gap:8px;
      padding:10px 12px; border-radius: 999px;
      background: var(--chip-bg); border:1px solid var(--stroke);
      cursor:pointer; user-select:none;
      transition: transform .06s, border-color .2s, background .2s, box-shadow .2s;
    }
    .chip:hover{ border-color: rgba(134,247,194,.7); box-shadow: 0 0 0 6px rgba(134,247,194,.10)}
    .chip input{ display:none }
    .chip[data-on="true"]{
      background: linear-gradient(180deg, rgba(93,211,255,.2), rgba(134,247,194,.12));
      border-color: rgba(93,211,255,.6);
      box-shadow: inset 0 0 0 1px rgba(93,211,255,.35), 0 6px 18px rgba(0,0,0,.25);
    }
    .chip .dot{
      width:14px; height:14px; border-radius:50%;
      border:2px solid var(--accent); display:inline-block;
      background: transparent; box-shadow: inset 0 0 0 2px rgba(13,20,40,.6);
    }
    .chip[data-on="true"] .dot{ background: var(--accent) }

    .customWrap{
      display:flex; align-items:center; gap:10px;
      background: rgba(255,255,255,0.04);
      border:1px dashed var(--stroke);
      border-radius: 999px;
      padding:6px 10px 6px 6px;
    }
    .customWrap input[type="number"]{
      width:110px; padding:8px 10px; font-size:14px;
      background: transparent; border:0; color:var(--text); outline:none;
    }
    .customWrap .pctSuffix{ font-size:13px; color:var(--muted); border-left:1px solid var(--stroke); padding-left:10px }

    .actions{ display:flex; gap:10px; margin-top:8px; flex-wrap:wrap }
    .btn{
      appearance:none; border:0; cursor:pointer;
      padding:12px 16px; border-radius:12px;
      color:#06101a; font-weight:700;
      background: linear-gradient(180deg, var(--accent), #47b8df);
      box-shadow: 0 8px 20px rgba(93,211,255,.35), inset 0 -6px 18px rgba(0,0,0,.15);
      transition: transform .06s, filter .2s, box-shadow .2s;
    }
    .btn:hover{ filter: brightness(1.04) }
    .btn:active{ transform: translateY(1px) }
    .btn.outline{
      background: transparent; color: var(--text);
      border:1px solid var(--stroke); box-shadow:none;
    }
    .btn.ghost{
      background: transparent; color: var(--muted);
      border:1px dashed var(--stroke); box-shadow:none;
    }

    .result{
      display:grid; gap:12px; margin-top:10px; padding:14px;
      background: rgba(255,255,255,.05); border:1px solid var(--stroke);
      border-radius: var(--radius);
    }
    .rows{ display:grid; gap:8px }
    .r{ display:flex; justify-content:space-between; align-items:center; gap:10px }
    .r .k{ color:var(--muted); font-size:14px }
    .r .v{ font-variant-numeric: tabular-nums; font-weight:700 }
    .r.total{ padding-top:8px; margin-top:6px; border-top:1px dashed var(--stroke) }
    .badge{ font-size:12px; color:#0b1a13; font-weight:800; background: linear-gradient(180deg, var(--accent-2), #4fe2a3); padding:6px 10px; border-radius:999px }
    .muted{ color:var(--muted) }

    .error{ color: var(--danger); font-size:13px; display:none }
    .show{ display:block }

    footer{ margin-top:16px; text-align:center; color:var(--muted); font-size:12px; opacity:.9 }

    .shake{ animation: shake .25s linear }
    @keyframes shake{
      10%, 90% { transform: translateX(-1px) }
      20%, 80% { transform: translateX(2px) }
      30%, 50%, 70% { transform: translateX(-4px) }
      40%, 60% { transform: translateX(4px) }
    }

    /* Modal */
    .overlay{
      position:fixed; inset:0; background: rgba(0,0,0,.55);
      display:none; align-items:center; justify-content:center; padding:18px; z-index:50;
    }
    .overlay.show{ display:flex }
    .modal{
      width:min(600px, 96vw); background: var(--card); border:1px solid var(--stroke);
      border-radius:16px; box-shadow: var(--shadow); padding:18px 18px 14px; position:relative;
    }
    .modal h2{ margin:0 0 12px; font-size:18px }
    .modal .grid{ grid-template-columns: 1fr 1fr }
    .modal .grid > div.full{ grid-column: 1 / -1 }
    .modal .actions{ justify-content: flex-end; margin-top: 4px }
    .hidden{ display:none !important }

    /* QR area */
    .qrWrap{
      display:grid; gap:12px; margin-top:14px; padding:14px;
      background: rgba(255,255,255,.05); border:1px dashed var(--stroke); border-radius: var(--radius);
    }
    .qrBox{ display:flex; gap:16px; align-items:center; flex-wrap:wrap }
    canvas.qr{ border-radius:12px; background:#fff; padding:6px }
    .small{ font-size:12px; color:var(--muted) }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="shell">
      <!-- Coluna esquerda: formulário -->
      <section class="card" id="formCard">
        <h1>Calculadora de Energia • SCEE</h1>
        <p class="sub">Informe a injeção (kWh) e o preço unitário com tributos para calcular o valor base. Depois escolha o desconto a conceder.</p>

        <div class="grid">
          <div>
            <label class="lbl" for="inj">INJEÇÃO SCEE (kWh)</label>
            <div class="field">
              <input id="inj" class="inp" type="text" inputmode="decimal" placeholder="Ex: 1.250,75 ou 1250.75" autocomplete="off">
              <span class="suffix">kWh</span>
            </div>
          </div>

          <div>
            <label class="lbl" for="unit">Preço unit R$ com Tributos</label>
            <div class="field">
              <input id="unit" class="inp" type="text" inputmode="decimal" placeholder="Ex: 0,89 ou 0.89" autocomplete="off">
              <span class="suffix">R$/kWh</span>
            </div>
          </div>

          <div>
            <label class="lbl">Desconto a conceder</label>
            <div class="row" id="discountRow" aria-label="Opções de desconto">
              <label class="chip"><input type="radio" name="pct" value="5"><span class="dot"></span>5%</label>
              <label class="chip"><input type="radio" name="pct" value="10"><span class="dot"></span>10%</label>
              <label class="chip"><input type="radio" name="pct" value="15"><span class="dot"></span>15%</label>
              <label class="chip"><input type="radio" name="pct" value="20"><span class="dot"></span>20%</label>
              <label class="chip"><input type="radio" name="pct" value="25"><span class="dot"></span>25%</label>
              <label class="chip"><input type="radio" name="pct" value="35"><span class="dot"></span>35%</label>

              <!-- custom -->
              <label class="chip" id="chipCustom">
                <input type="radio" name="pct" value="custom">
                <span class="dot"></span>
                <span class="customWrap">
                  <span class="muted">Personalizar</span>
                  <input id="customPct" type="number" min="0" max="100" step="0.1" placeholder="0,0" disabled>
                  <span class="pctSuffix">%</span>
                </span>
              </label>
            </div>

            <div class="actions">
              <button id="showDiscountsBtn" class="btn ghost hidden" type="button" title="Reexibir opções de desconto">Reexibir descontos</button>
            </div>
          </div>

          <div class="actions">
            <button id="calcBtn" class="btn" type="button">Calcular</button>
            <button id="clearBtn" class="btn outline" type="button" title="Limpar">Limpar</button>
          </div>

          <span id="err" class="error">Preencha INJEÇÃO e Preço unitário com números válidos. O desconto deve estar entre 0% e 100%.</span>

          <div id="res" class="result" hidden>
            <div class="rows">
              <div class="r"><span class="k">Valor base (Injeção × Preço unit):</span><span class="v" id="vBase">R$ 0,00</span></div>
              <div class="r"><span class="k">Desconto aplicado:</span><span class="v" id="vPct">0%</span></div>
              <div class="r"><span class="k">Valor do desconto:</span><span class="v" id="vDesc">R$ 0,00</span></div>
              <div class="r total">
                <span class="k">Valor a receber do cliente</span>
                <span class="v" id="vFinal">R$ 0,00</span>
              </div>
            </div>
            <div class="actions" style="margin-top:6px">
              <button class="btn" id="copyBtn" type="button">Copiar valor final</button>
              <span class="badge" id="copied" hidden>Copiado</span>
            </div>
            <small class="muted">Observação: arredondamento exibido em moeda BRL.</small>
          </div>
        </div>
      </section>

      <!-- Coluna direita: resumo visual -->
      <section class="card">
        <h1>Resumo rápido</h1>
        <div class="rows">
          <div class="r"><span class="k">Injeção informada</span><span class="v" id="sInj">—</span></div>
          <div class="r"><span class="k">Preço unit c/ tributos</span><span class="v" id="sUnit">—</span></div>
          <div class="r"><span class="k">Desconto escolhido</span><span class="v" id="sPct">—</span></div>
        </div>

        <div class="result" style="margin-top:14px">
          <div class="r total">
            <span class="k">Cliente deve pagar</span>
            <span class="v" id="sFinal" style="font-size:22px">R$ 0,00</span>
          </div>

          <div class="actions" style="margin-top:10px">
            <button id="payBtn" class="btn" type="button">Gerar Pagamento</button>
          </div>

          <!-- Área onde o QR será inserido após gerar -->
          <div id="qrArea" class="qrWrap hidden">
            <div class="qrBox">
              <canvas id="qrCanvas" class="qr" width="256" height="256"></canvas>
              <div style="min-width:260px; max-width:380px">
                <div class="r"><span class="k">Valor</span><span class="v" id="qrValor">R$ 0,00</span></div>
                <div class="r"><span class="k">Txid</span><span class="v" id="qrTxid">—</span></div>
                <p class="small" style="margin:10px 0 0">Use o QR Code no app do banco ou copie o código abaixo.</p>
              </div>
            </div>
            <div>
              <textarea id="qrPayload" class="inp" rows="3" readonly></textarea>
            </div>
            <div class="actions">
              <button id="copyPayload" class="btn outline" type="button">Copiar código</button>
              <button id="downloadQR" class="btn outline" type="button">Baixar PNG</button>
            </div>
          </div>

          <footer>Calculadora de Energia • SCEE • v1.2</footer>
        </div>
      </section>
    </div>
  </div>

  <!-- Modal de pagamento -->
  <div id="overlay" class="overlay" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
    <div class="modal">
      <h2 id="modalTitle">Gerar pagamento PIX</h2>
      <div class="grid">
        <div class="full">
          <label class="lbl" for="pixKey">Chave Pix</label>
          <input id="pixKey" class="inp" type="text" placeholder="CPF/CNPJ, e-mail, telefone ou chave aleatória">
        </div>
        <div>
          <label class="lbl" for="pixName">Nome do recebedor</label>
          <input id="pixName" class="inp" type="text" maxlength="25" placeholder="Ex: Jalecos Mania">
        </div>
        <div>
          <label class="lbl" for="pixCity">Cidade</label>
          <input id="pixCity" class="inp" type="text" maxlength="15" placeholder="Ex: ANAPOLIS">
        </div>
        <div>
          <label class="lbl" for="pixAmount">Valor (BRL)</label>
          <input id="pixAmount" class="inp" type="text" inputmode="decimal" placeholder="Ex: 199,90">
        </div>
        <div>
          <label class="lbl" for="pixTxid">Txid (opcional)</label>
          <input id="pixTxid" class="inp" type="text" maxlength="25" placeholder="Autogerado se vazio">
        </div>
        <div class="full">
          <label class="lbl" for="pixDesc">Descrição (opcional)</label>
          <input id="pixDesc" class="inp" type="text" maxlength="60" placeholder="Ex: Pagamento SCEE ref. Setembro">
        </div>
      </div>
      <div class="actions">
        <button id="cancelModal" class="btn outline" type="button">Cancelar</button>
        <button id="genPix" class="btn" type="button">Gerar QR Code</button>
      </div>
    </div>
  </div>

  <script>
    /* ====== Utilidades ====== */
    function toNumber(str){
      if (typeof str !== 'string') return NaN;
      let s = str.trim().replace(/\s+/g,'');
      if (s === '') return NaN;
      const hasComma = s.includes(',');
      const hasDot   = s.includes('.');
      if (hasComma && hasDot){
        const lastComma = s.lastIndexOf(',');
        const lastDot   = s.lastIndexOf('.');
        const decimalIsComma = lastComma > lastDot;
        if (decimalIsComma){
          s = s.replace(/\./g,'').replace(',','.');
        } else {
          s = s.replace(/,/g,'');
        }
      } else if (hasComma && !hasDot){
        s = s.replace(',','.');
      }
      return Number(s);
    }
    const fmtBRL = (n) => new Intl.NumberFormat('pt-BR', { style:'currency', currency:'BRL' }).format(isFinite(n)? n : 0);
    const clamp = (v, min, max) => Math.min(Math.max(v, min), max);

    /* ====== Elementos ====== */
    const inj = document.getElementById('inj');
    const unit = document.getElementById('unit');
    const err = document.getElementById('err');
    const resBox = document.getElementById('res');

    const vBase = document.getElementById('vBase');
    const vPct = document.getElementById('vPct');
    const vDesc = document.getElementById('vDesc');
    const vFinal = document.getElementById('vFinal');

    const sInj = document.getElementById('sInj');
    const sUnit = document.getElementById('sUnit');
    const sPct = document.getElementById('sPct');
    const sFinal = document.getElementById('sFinal');

    const calcBtn = document.getElementById('calcBtn');
    const clearBtn = document.getElementById('clearBtn');
    const copyBtn = document.getElementById('copyBtn');
    const copied = document.getElementById('copied');

    const discountRow = document.getElementById('discountRow');
    const chipCustom = document.getElementById('chipCustom');
    const customPct = document.getElementById('customPct');
    const showDiscountsBtn = document.getElementById('showDiscountsBtn');

    const chips = [...discountRow.querySelectorAll('.chip')];
    const radioNodes = [...discountRow.querySelectorAll('input[type="radio"]')];

    const payBtn = document.getElementById('payBtn');
    const overlay = document.getElementById('overlay');
    const cancelModal = document.getElementById('cancelModal');
    const genPixBtn = document.getElementById('genPix');

    const pixKey = document.getElementById('pixKey');
    const pixName = document.getElementById('pixName');
    const pixCity = document.getElementById('pixCity');
    const pixAmount = document.getElementById('pixAmount');
    const pixTxid = document.getElementById('pixTxid');
    const pixDesc = document.getElementById('pixDesc');

    const qrArea = document.getElementById('qrArea');
    const qrValor = document.getElementById('qrValor');
    const qrTxidEl = document.getElementById('qrTxid');
    const qrPayload = document.getElementById('qrPayload');
    const copyPayloadBtn = document.getElementById('copyPayload');
    const downloadQRBtn = document.getElementById('downloadQR');

    /* ====== Chips de desconto ====== */
    function syncChips(){
      radioNodes.forEach(r => {
        const chip = r.closest('.chip');
        chip.dataset.on = r.checked ? 'true':'false';
      });
      if (chipCustom.querySelector('input[type="radio"]').checked) {
        customPct.disabled = false; customPct.focus();
      } else {
        customPct.disabled = true;
      }
    }
    function hideDiscounts(){
      discountRow.classList.add('hidden');
      showDiscountsBtn.classList.remove('hidden');
    }
    function showDiscounts(){
      discountRow.classList.remove('hidden');
      showDiscountsBtn.classList.add('hidden');
    }
    radioNodes.forEach(r => r.addEventListener('change', () => { syncChips(); calculate(); hideDiscounts(); }));
    chips.forEach(ch => ch.addEventListener('keydown', (e)=>{
      if(e.key === 'Enter' || e.key === ' '){
        const r = ch.querySelector('input[type="radio"]');
        r.checked = true;
        r.dispatchEvent(new Event('change', {bubbles:true}));
        e.preventDefault();
      }
    }));
    showDiscountsBtn.addEventListener('click', showDiscounts);

    // Seleção padrão 10%
    const defaultRadio = radioNodes.find(r => r.value === '10');
    if (defaultRadio){ defaultRadio.checked = true; }
    syncChips();

    function getSelectedPct(){
      const selected = radioNodes.find(r => r.checked);
      if (!selected) return NaN;
      if (selected.value === 'custom'){
        const raw = String(customPct.value ?? '').replace(',','.');
        const v = Number(raw);
        return clamp(isFinite(v) ? v : NaN, 0, 100);
      }
      return Number(selected.value);
    }

    /* ====== Cálculo principal ====== */
    function calculate(){
      err.classList.remove('show');
      copied.hidden = true;

      const nInj = toNumber(inj.value);
      const nUnit = toNumber(unit.value);
      const pctSel = getSelectedPct();

      if (!isFinite(nInj) || nInj < 0 || !isFinite(nUnit) || nUnit < 0 || !isFinite(pctSel)){
        resBox.hidden = true;
        if ((inj.value || unit.value)) {
          err.classList.add('show');
          document.getElementById('formCard').classList.add('shake');
          setTimeout(()=>document.getElementById('formCard').classList.remove('shake'), 300);
        }
        sInj.textContent = '—';
        sUnit.textContent = '—';
        sPct.textContent = '—';
        sFinal.textContent = fmtBRL(0);
        return;
      }

      const base = nInj * nUnit;
      const desconto = base * (pctSel/100);
      const final = base - desconto;

      vBase.textContent  = fmtBRL(base);
      vPct.textContent   = `${pctSel.toLocaleString('pt-BR')}%`;
      vDesc.textContent  = fmtBRL(desconto);
      vFinal.textContent = fmtBRL(final);

      sInj.textContent   = `${nInj.toLocaleString('pt-BR')} kWh`;
      sUnit.textContent  = `${fmtBRL(nUnit)} / kWh`;
      sPct.textContent   = `${pctSel.toLocaleString('pt-BR')}%`;
      sFinal.textContent = fmtBRL(final);

      resBox.hidden = false;

      // Atualiza valor do modal se estiver aberto
      pixAmount.value = (final || 0).toLocaleString('pt-BR', {minimumFractionDigits:2, maximumFractionDigits:2});
    }

    calcBtn.addEventListener('click', calculate);
    [inj, unit].forEach(el=>{
      el.addEventListener('input', calculate);
      el.addEventListener('blur', calculate);
      el.addEventListener('keydown', e=>{ if(e.key === 'Enter'){ calculate(); }});
    });
    customPct.addEventListener('input', calculate);
    customPct.addEventListener('keydown', e=>{ if(e.key === 'Enter'){ calculate(); }});

    // Limpar
    clearBtn.addEventListener('click', ()=>{
      inj.value = ''; unit.value = ''; customPct.value = '';
      radioNodes.forEach(r => r.checked = false);
      if (defaultRadio){ defaultRadio.checked = true; }
      syncChips(); showDiscounts();
      err.classList.remove('show'); resBox.hidden = true;
      sInj.textContent = '—'; sUnit.textContent = '—'; sPct.textContent = '—'; sFinal.textContent = fmtBRL(0);
      qrArea.classList.add('hidden');
      qrPayload.value = '';
    });

    // Copiar valor final
    copyBtn.addEventListener('click', async ()=>{
      const val = vFinal.textContent;
      try{
        await navigator.clipboard.writeText(val);
        copied.hidden = false;
        setTimeout(()=> copied.hidden = true, 1400);
      }catch{
        copied.textContent = 'Falhou ao copiar';
        copied.hidden = false;
        copied.style.background = 'linear-gradient(180deg,#ffb3b3,#ff6b6b)';
        setTimeout(()=> {
          copied.hidden = true;
          copied.textContent = 'Copiado';
          copied.style.background = '';
        }, 1600);
      }
    });

    /* ====== Modal de Pagamento ====== */
    function openModal(){
      // Pré-preenche
      pixAmount.value = (toNumber(vFinal.textContent.replace(/[^\d,.-]/g,'')) || 0).toLocaleString('pt-BR', {minimumFractionDigits:2, maximumFractionDigits:2});
      if (!pixTxid.value) pixTxid.value = 'SCEE-' + new Date().toISOString().replace(/[-:.TZ]/g,'').slice(0,14);
      overlay.classList.add('show');
      setTimeout(()=> pixKey.focus(), 50);
    }
    function closeModal(){ overlay.classList.remove('show') }

    payBtn.addEventListener('click', ()=>{
      if (resBox.hidden){ calculate(); }
      openModal();
    });
    cancelModal.addEventListener('click', closeModal);
    overlay.addEventListener('click', (e)=>{ if(e.target === overlay) closeModal(); });
    document.addEventListener('keydown', (e)=>{ if(e.key === 'Escape') closeModal(); });

    /* ====== Geração de BR Code PIX ====== */
    function tlv(id, value){
      const len = String(value.length).padStart(2,'0');
      return id + len + value;
    }
    function crc16(payload){
      // CRC16-CCITT (0x1021), init 0xFFFF
      let crc = 0xFFFF;
      for (let i=0; i<payload.length; i++){
        crc ^= payload.charCodeAt(i) << 8;
        for(let j=0; j<8; j++){
          crc = (crc & 0x8000) ? (crc << 1) ^ 0x1021 : (crc << 1);
          crc &= 0xFFFF;
        }
      }
      return crc.toString(16).toUpperCase().padStart(4,'0');
    }
    function buildPixPayload({key, name, city, amount, txid, desc}){
      // Constrói EMV (BR Code) estático com amount fixo
      const gui = tlv('00','br.gov.bcb.pix');
      const keyT = tlv('01', key);
      const descT = desc ? tlv('02', desc) : '';
      const mai = tlv('26', gui + keyT + descT);

      const mcc = tlv('52','0000');          // MCC
      const cur = tlv('53','986');           // BRL
      const amt = amount ? tlv('54', amount) : '';
      const cty = tlv('58','BR');
      const nm  = tlv('59', name);
      const cy  = tlv('60', city.toUpperCase());
      const addData = tlv('62', tlv('05', txid || '***'));

      const base = tlv('00','01') + tlv('01','11') + mai + mcc + cur + amt + cty + nm + cy + addData;
      const toCRC = base + '6304';
      const crc = crc16(toCRC);
      return toCRC + crc;
    }

    /* ====== QRCode (lib embutida minificada) ====== */
    /*! qrcode.js (Kazuhiko Arase) - versão reduzida */
    // eslint-disable-next-line
    (function(){function u(a){this.mode=1;this.data=a}function v(a){this.mode=2;this.data=a}function w(a){this.mode=4;this.data=a}
    var x={L:1,M:0,Q:3,H:2},y=[[],[6,18],[6,22],[6,26],[6,30],[6,34]],z=function(a,b){for(var c=0;c<b.length;c++)a.push(b[c])},
    A=function(a,b){this.buffer=[];this.length=0;this.put=function(c,d){for(var e=0;e<d;e++)this.putBit((c>>>d-e-1&1)==1)};this.putBit=function(c){this.buffer.push(c);this.length++}};
    function B(a){this.typeNumber=a;this.modules=null;this.moduleCount=0;this.dataList=[];this.errorCorrectLevel=x.M}
    B.prototype={addData:function(a){/^[0-9]*$/.test(a)?this.dataList.push(new u(a)):/^[A-Z0-9 $%*+\-./:]*$/.test(a)?this.dataList.push(new v(a)):this.dataList.push(new w(a))},
    make:function(){this.moduleCount=4*this.typeNumber+17;this.modules=new Array(this.moduleCount);for(var a=0;a<this.moduleCount;a++){this.modules[a]=new Array(this.moduleCount);for(var b=0;b<this.moduleCount;b++)this.modules[a][b]=null}
    this.setupPositionProbePattern(0,0);this.setupPositionProbePattern(this.moduleCount-7,0);this.setupPositionProbePattern(0,this.moduleCount-7);for(a=8;a<this.moduleCount-8;a++)null===this.modules[a][6]&&(this.modules[a][6]=a%2==0);
    for(a=8;a<this.moduleCount-8;a++)null===this.modules[6][a]&&(this.modules[6][a]=a%2==0);this.mapData(this.createData());},
    isDark:function(a,b){return this.modules[a][b]},setupPositionProbePattern:function(a,b){for(var c=-1;7>=c;c++)if(!(a+c<=-1||this.moduleCount<=a+c))for(var d=-1;7>=d;d++)b+d<=-1||this.moduleCount<=b+d||(this.modules[a+c][b+d]=0<=c&&c<=6&&(0==d||6==d)||0<=d&&d<=6&&(0==c||6==c)||2<=c&&c<=4&&2<=d&&d<=4)},
    mapData:function(a){for(var b=-1,c=this.moduleCount-1,d=7,e=0,f=this.moduleCount-1;0<f;f-=2){6==f&&f--;for(;;){for(var g=0;2>g;g++)null===this.modules[c][f-g]&&(this.modules[c][f-g]=((a[e>>>3]>>>7-e%8&1)==1));e++;if(0>c||this.moduleCount<=c){c+=b;b*=-1;break}c+=b}}},createData:function(){var a=new A;for(var b=0;b<this.dataList.length;b++){var c=this.dataList[b];if(c.mode==1){a.put(1,4);a.put(c.data.length,10);for(var d=0;d<c.data.length;d+=3){var e=Math.min(3,c.data.length-d);a.put(parseInt(c.data.substr(d,e),10),e*3+1)}}
    else if(c.mode==2){a.put(2,4);a.put(c.data.length,9);for(d=0;d<c.data.length;d++){e="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ $%*+-./:".indexOf(c.data.charAt(d));a.put(e,6)}}
    else{a.put(4,4);a.put(c.data.length,8);for(d=0;d<c.data.length;d++)a.put(c.data.charCodeAt(d),8)}}for(b=0;40>=b;b++){var f=new B(b);try{return f.dataList=this.dataList,f.make(),function(){for(var g=[],h=0;h<f.moduleCount;h++){g.push([]);for(var k=0;k<f.moduleCount;k++)g[h].push(f.isDark(h,k))}return g}()}catch(m){}}throw"QR fail"}};
    function drawQR(canvas, text, scale){scale=scale||8;var ctx=canvas.getContext('2d');var qr=new z([],[]);var o=new B(1);o.addData(text);o.make();var cells=o.modules.length;var size=cells*scale;canvas.width=size;canvas.height=size;ctx.fillStyle="#fff";ctx.fillRect(0,0,size,size);ctx.fillStyle="#000";
      for(var r=0;r<cells;r++){for(var c=0;c<cells;c++){if(o.isDark(r,c)){ctx.fillRect(c*scale,r*scale,scale,scale)}}}}
    window.__drawQR = drawQR;
    })();

    /* ====== Fluxo: gerar PIX e QR ====== */
    function sanitizeAmountBRL(str){
      const n = toNumber(str); return (isFinite(n) ? n : 0).toFixed(2);
    }
    genPixBtn.addEventListener('click', ()=>{
      const key = (pixKey.value || '').trim();
      const name = (pixName.value || '').trim() || 'RECEBEDOR';
      const city = (pixCity.value || '').trim() || 'CIDADE';
      const amount = sanitizeAmountBRL(pixAmount.value || vFinal.textContent);
      const txid = (pixTxid.value || '').trim() || ('SCEE-' + Math.random().toString(36).slice(2,8).toUpperCase());
      const desc = (pixDesc.value || '').trim();

      if (!key){
        alert('Informe a Chave Pix.'); pixKey.focus(); return;
      }
      if (parseFloat(amount) <= 0){
        alert('Valor inválido.'); pixAmount.focus(); return;
      }

      const payload = buildPixPayload({
        key, name, city, amount, txid, desc
      });

      // Desenha QR
      const canvas = document.getElementById('qrCanvas');
      window.__drawQR(canvas, payload, 6);

      // Preenche infos
      qrValor.textContent = fmtBRL(parseFloat(amount));
      qrTxidEl.textContent = txid;
      qrPayload.value = payload;

      // Exibe área
      qrArea.classList.remove('hidden');
      closeModal();
    });

    // Copiar payload
    copyPayloadBtn.addEventListener('click', async ()=>{
      try{
        await navigator.clipboard.writeText(qrPayload.value);
        copyPayloadBtn.textContent = 'Copiado!';
        setTimeout(()=> copyPayloadBtn.textContent = 'Copiar código', 1200);
      }catch{
        copyPayloadBtn.textContent = 'Falhou';
        setTimeout(()=> copyPayloadBtn.textContent = 'Copiar código', 1200);
      }
    });

    // Baixar PNG
    downloadQRBtn.addEventListener('click', ()=>{
      const canvas = document.getElementById('qrCanvas');
      const link = document.createElement('a');
      link.download = `PIX_${(qrTxidEl.textContent||'qr')}.png`;
      link.href = canvas.toDataURL('image/png');
      link.click();
    });
  </script>
</body>
</html>
